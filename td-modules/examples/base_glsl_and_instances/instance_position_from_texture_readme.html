<!DOCTYPE html>
<html>
<head>    
    <link rel="stylesheet" href="../../../assets/styles.css">
</head>
<body>

<h1>GLSL and Instances</h1>
<h2>Textures to Displace Instances</h2>
<hr>

<p>
    While the previous example demonstrates how we can think of displacement purely in terms of mathmatics, it can sometimes be helpful instead to do this with a texture. Just like we can use height maps for displacing a mesh, we can use a similar principle for manipulating instances directly. In the most recent builds of TouchDesinger there are alternative ways to approach this set of manipulations - this set of examples, however, still stands as a reference for how to take advantage of instance manipulation in the vertex stage. 
    <br><br>
    Here a texture is used to represent the change in height for our instances. In order to correctly sample a pixel value from this image we'll use a helper fucntion <code>CoordsFromTex()</code>. This function will return an ivec2 with a set of x and y coordinates that we'll use to sample the texture. Here's our helper function:
    <br><br>
<code>ivec2 CoordsFromTex(vec2 size, int id){
    float xCoord = mod(float(id), size.x);
    float yCoord = fract( (float(id) / (size.x * size.y)) ) * size.y;
    return ivec2(int(xCoord), int(yCoord));
}
</code>
    <br><br>
    This function takes a vec2 that describes the dimensions of our texture (the number of pixels in x and y), and the instance ID. From those two values we can derive the pixel coordinate where we want to sample. These values will be used with <code>texelFetch()</code> - a function that provides pixel accurate results, prefered over the altnerative <code>texture()</code> function which uses noramlized coordinates. In the following three lines we'll use this function to look up our texel, retrieve the value from the red channel, scale this by a uniform <code>u_disp_scale</code>, and finally add it to our new instance position:
    <br><br>
<code>ivec2 xyLookup  = CoordsFromTex(u_instance_pos, TDInstanceID());
float translate_y = texelFetch(s_disp, xyLookup, 0).r * u_disp_scale;
vec3 new_p = vec3(P.x, P.y + translate_y, P.z); 
</code>
    <br><br>
This new result is used in our <code>TDDeform()</code> function. Try feeding the null TOP <code>null_disp</code> another 100 x 100 pixel image to see this at play.
</p> 

<hr>

<br>

<footer>
    Tested in TouchDesigner099 2019.20140 <br>
    Updated 05.15.20 <br>
    Matthew Ragan
</footer>

</body>
</html> 